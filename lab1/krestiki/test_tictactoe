import pytest
from main import TicTacToe 

@pytest.fixture
def game():
    return TicTacToe()


def test_initial_state(game):
    assert game.size == 3
    assert game.current_player == "X"
    assert not game.game_over
    assert game.winner is None
    assert all(cell == " " for row in game.board for cell in row)


def test_valid_move_and_turn_switch(game):
    assert game.is_valid_move(0, 0)
    game.make_move(0, 0)
    assert game.board[0][0] == "X"
    assert game.current_player == "O"


def test_invalid_move_same_cell(game):
    game.make_move(0, 0)
    assert not game.make_move(0, 0)  


def test_invalid_move_out_of_bounds(game):
    assert not game.is_valid_move(5, 5)


def test_check_win_row():
    g = TicTacToe()
    for c in range(3):
        g[(0, c)] = g.current_player
    assert g.game_over
    assert g.winner == "X"


def test_check_win_col():
    g = TicTacToe()
    for r in range(3):
        g[(r, 1)] = g.current_player
    assert g.game_over
    assert g.winner == "X"


def test_check_win_main_diag():
    g = TicTacToe()
    g[(0, 0)] = "X"
    g[(1, 1)] = "X"
    g[(2, 2)] = "X"
    assert g.check_win(2, 2)
    assert g.winner == "X" or g.winner is None  


def test_check_win_anti_diag():
    g = TicTacToe()
    g[(0, 2)] = "X"
    g[(1, 1)] = "X"
    g[(2, 0)] = "X"
    assert g.check_win(2, 0)


def test_check_draw():
    g = TicTacToe()
    pattern = [
        ["X", "O", "X"],
        ["X", "O", "O"],
        ["O", "X", "X"],
    ]
    g.board = pattern
    assert g.check_draw()


def test_getitem_and_setitem():
    g = TicTacToe()
    g[(0, 0)] = "X"
    assert g[(0, 0)] == "X"
    with pytest.raises(ValueError):
        g[(0, 0)] = "O"  


def test_invalid_setitem_index():
    g = TicTacToe()
    with pytest.raises(ValueError):
        g["not_tuple"] = "X"


def test_invalid_symbol():
    g = TicTacToe()
    with pytest.raises(ValueError):
        g[(0, 0)] = "Z"


def test_wrong_player_turn():
    g = TicTacToe()
    g[(0, 0)] = "X"
    with pytest.raises(ValueError):
        g[(1, 1)] = "X" 


def test_make_move_returns_bool():
    g = TicTacToe()
    assert g.make_move(0, 0)
    assert not g.make_move(0, 0) 


def test_get_board_state_is_copy():
    g = TicTacToe()
    state = g.get_board_state()
    state[0][0] = "Z"
    assert g.board[0][0] == " "  


def test_reset_resets_state():
    g = TicTacToe()
    g.make_move(0, 0)
    g.reset()
    assert g.current_player == "X"
    assert not g.game_over
    assert all(cell == " " for row in g.board for cell in row)


def test_str_output():
    g = TicTacToe()
    g.make_move(0, 0)
    s = g.str()
    assert "X" in s
    assert "|" in s
    assert "-" in s
